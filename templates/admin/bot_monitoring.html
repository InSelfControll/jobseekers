{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Telegram Bot Health Dashboard</h2>
    
    <div class="row mt-4">
        <!-- Status Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Status</h5>
                    <p class="card-text">
                        <span id="bot-status" class="badge"></span>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Messages Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Messages</h5>
                    <p class="card-text" id="message-count">0</p>
                    <small class="text-muted">Last message: <span id="last-message-time">Never</span></small>
                </div>
            </div>
        </div>
        
        <!-- Performance Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Performance</h5>
                    <p>Memory: <span id="memory-usage">0</span> MB</p>
                    <p>CPU: <span id="cpu-usage">0</span>%</p>
                </div>
            </div>
        </div>
        
        <!-- Uptime Card -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Uptime</h5>
                    <p class="card-text" id="uptime">0d 0h 0m</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Response Time Chart -->
    <div class="row mt-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Response Times</h5>
                    <canvas id="response-time-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Recent Errors -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Recent Errors</h5>
                    <div id="error-list" class="overflow-auto" style="max-height: 300px;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize if we're on the monitoring page
    if (!document.getElementById('bot-status')) {
        return;
    }
let responseTimeChart;

function updateStatus(status) {
    const statusElem = document.getElementById('bot-status');
    statusElem.textContent = status;
    statusElem.className = 'badge ' + 
        (status === 'running' ? 'bg-success' : 
         status === 'stopped' ? 'bg-danger' : 'bg-warning');
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${days}d ${hours}h ${minutes}m`;
}

function updateDashboard(metrics) {
    // Update status
    updateStatus(metrics.status);
    
    // Update counters
    document.getElementById('message-count').textContent = metrics.message_count;
    document.getElementById('memory-usage').textContent = metrics.memory_usage.toFixed(2);
    document.getElementById('cpu-usage').textContent = metrics.cpu_usage.toFixed(1);
    document.getElementById('uptime').textContent = formatUptime(metrics.uptime);
    
    // Update last message time
    const lastMessageTime = metrics.last_message_time ? 
        new Date(metrics.last_message_time).toLocaleString() : 'Never';
    document.getElementById('last-message-time').textContent = lastMessageTime;
    
    // Update error list
    const errorList = document.getElementById('error-list');
    errorList.innerHTML = metrics.recent_errors.map(error => 
        `<div class="alert alert-danger mb-2 small">${error}</div>`
    ).join('');
    
    // Update response time chart
    if (responseTimeChart) {
        responseTimeChart.data.labels = metrics.response_times.map((_, i) => i + 1);
        responseTimeChart.data.datasets[0].data = metrics.response_times;
        responseTimeChart.update();
    } else {
        const ctx = document.getElementById('response-time-chart').getContext('2d');
        responseTimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: metrics.response_times.map((_, i) => i + 1),
                datasets: [{
                    label: 'Response Time (s)',
                    data: metrics.response_times,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Set up SSE connection
const evtSource = new EventSource("/admin/bot-metrics-stream");
evtSource.onmessage = function(event) {
    const metrics = JSON.parse(event.data);
    updateDashboard(metrics);
};

evtSource.onerror = function(err) {
    console.error("EventSource failed:", err);
    updateStatus('error');
};
});
</script>
{% endblock %}
{% endblock %}
